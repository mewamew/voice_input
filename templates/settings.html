<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³è¾“å…¥è®¾ç½®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.5;
        }

        .container {
            display: flex;
            max-width: 900px;
            margin: 40px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 200px;
            min-width: 200px;
            background: #fafafa;
            border-right: 1px solid #e5e5e5;
            padding: 20px 0;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            padding: 0 20px 20px;
            border-bottom: 1px solid #e5e5e5;
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            color: #666;
            white-space: nowrap;
        }

        .nav-item:hover {
            background: #f0f0f0;
        }

        .nav-item.active {
            background: #e8e8e8;
            color: #1d1d1f;
            font-weight: 500;
        }

        .nav-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        /* å†…å®¹åŒº */
        .content {
            flex: 1;
            padding: 30px;
            min-height: 400px;
            min-width: 0;
            overflow: hidden;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .section-desc {
            color: #86868b;
            margin-bottom: 24px;
        }

        /* è¡¨å• */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 15px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
        }

        .form-hint {
            font-size: 13px;
            color: #86868b;
            margin-top: 6px;
        }

        /* ä¿å­˜æç¤º */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1d1d1f;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: #fafafa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-weight: 500;
            margin-bottom: 12px;
        }

        /* å¼€å…³æ ·å¼ */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-label {
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #0071e3;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .toggle-switch input:disabled + .toggle-slider {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }

        .toggle-switch input:disabled + .toggle-slider:before {
            background-color: #f5f5f5;
        }

        /* æ–‡æœ¬æ¡†æ ·å¼ */
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 15px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.15);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s, opacity 0.2s;
        }

        .btn-primary {
            background: #0071e3;
            color: #fff;
        }

        .btn-primary:hover {
            background: #0062cc;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .test-result {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .test-result.success {
            display: block;
            background: #d4edda;
            color: #155724;
        }

        .test-result.error {
            display: block;
            background: #f8d7da;
            color: #721c24;
        }

        .test-result.loading {
            display: block;
            background: #e2e3e5;
            color: #383d41;
        }

        /* çª—å£å¤§å°é€‰æ‹©å™¨ */
        .window-size-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .window-size-btn {
            width: 36px;
            height: 36px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .window-size-btn:hover {
            border-color: #0071e3;
        }

        .window-size-btn.active {
            background: #0071e3;
            color: #fff;
            border-color: #0071e3;
        }

        /* TTL æ»‘å—æ ·å¼ */
        .ttl-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-range {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #d2d2d7;
            border-radius: 3px;
            outline: none;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #0071e3;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .form-range::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .form-range::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #0071e3;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .ttl-value {
            min-width: 70px;
            font-weight: 500;
            color: #0071e3;
        }

        /* å†å²æ¶ˆæ¯åˆ—è¡¨ */
        .history-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            background: #fff;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-index {
            font-size: 12px;
            color: #86868b;
            width: 24px;
            flex-shrink: 0;
        }

        .history-text {
            flex: 1;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-text.in-window {
            color: #1d1d1f;
        }

        .history-text.out-window {
            color: #86868b;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }

        .history-btn {
            padding: 4px 10px;
            font-size: 12px;
            border: 1px solid #d2d2d7;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-btn:hover {
            background: #f5f5f5;
        }

        .history-btn.delete {
            color: #dc3545;
            border-color: #dc3545;
        }

        .history-btn.delete:hover {
            background: #fff5f5;
        }

        .history-empty {
            padding: 20px;
            text-align: center;
            color: #86868b;
            font-size: 14px;
        }

        .clear-all-btn {
            margin-top: 12px;
        }

        .btn-danger {
            background: #dc3545;
            color: #fff;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #1d1d1f;
            border: 1px solid #d2d2d7;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
        }

        /* ç¼–è¾‘æ¨¡æ€æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        .window-indicator {
            font-size: 12px;
            color: #0071e3;
            margin-left: 8px;
        }

        /* ä½¿ç”¨ç»Ÿè®¡æ ·å¼ */
        .stats-summary {
            display: flex;
            gap: 40px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #0071e3;
            display: block;
        }
        .stat-label {
            font-size: 14px;
            color: #86868b;
        }
        .stats-history-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .stats-history-item {
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .stats-history-item:last-child {
            border-bottom: none;
        }
        .stats-history-text {
            font-size: 14px;
            margin-bottom: 4px;
            word-break: break-all;
        }
        .stats-history-time {
            font-size: 12px;
            color: #86868b;
        }
        .stats-loading {
            text-align: center;
            padding: 20px;
            color: #86868b;
        }
        .stats-empty {
            text-align: center;
            padding: 40px 20px;
            color: #86868b;
            font-size: 14px;
        }

        /* ç‰ˆæœ¬çŠ¶æ€æ ‡ç­¾ */
        .status-badge {
            display: inline-block;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
        }
        .status-badge.auto {
            background: #d4edda;
            color: #155724;
        }
        .status-badge.manual {
            background: #fff3cd;
            color: #856404;
        }
        .status-badge.unchanged {
            background: #e2e3e5;
            color: #383d41;
        }

        /* ç‰ˆæœ¬è¯¦æƒ…å±•å¼€ */
        .version-details {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 13px;
        }
        .version-details.show {
            display: block;
        }
        .version-row {
            display: flex;
            margin-bottom: 6px;
        }
        .version-row:last-child {
            margin-bottom: 0;
        }
        .version-label {
            color: #86868b;
            width: 60px;
            flex-shrink: 0;
        }
        .version-text {
            flex: 1;
            word-break: break-all;
        }
        .version-text.changed {
            color: #0071e3;
        }
        .expand-btn {
            padding: 2px 8px;
            font-size: 11px;
            border: 1px solid #d2d2d7;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 4px;
        }
        .expand-btn:hover {
            background: #f5f5f5;
        }

        /* ä½¿ç”¨è¯´æ˜æ ·å¼ */
        .help-content {
            font-size: 14px;
            line-height: 1.8;
        }

        .help-content p {
            margin-bottom: 12px;
        }

        .help-content ol, .help-content ul {
            margin: 12px 0;
            padding-left: 20px;
        }

        .help-content li {
            margin-bottom: 6px;
        }

        /* å¿«æ·é”®è®¾ç½®æ ·å¼ */
        .shortcut-display {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .shortcut-key {
            display: inline-block;
            padding: 12px 24px;
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .shortcut-record-btn {
            min-width: 160px;
            transition: all 0.3s;
        }

        .shortcut-record-btn.recording {
            background: #ff9500;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-title">è®¾ç½®</div>
            <div class="nav-item" data-section="shortcut">
                <span class="nav-icon">âŒ¨ï¸</span>
                <span>å¿«æ·é”®</span>
            </div>
            <div class="nav-item" data-section="microphone">
                <span class="nav-icon">ğŸ¤</span>
                <span>éº¦å…‹é£</span>
            </div>
            <div class="nav-item" data-section="recording">
                <span class="nav-icon">â±ï¸</span>
                <span>å½•éŸ³è®¾ç½®</span>
            </div>
            <div class="nav-item" data-section="asr">
                <span class="nav-icon">ğŸ§ </span>
                <span>è¯­éŸ³è¯†åˆ«æ¨¡å‹</span>
            </div>
            <div class="nav-item active" data-section="llm">
                <span class="nav-icon">ğŸ¤–</span>
                <span>å¤§è¯­è¨€æ¨¡å‹</span>
            </div>
            <div class="nav-item" data-section="stats">
                <span class="nav-icon">ğŸ“Š</span>
                <span>ä½¿ç”¨ç»Ÿè®¡</span>
            </div>
            <div class="nav-item" data-section="help">
                <span class="nav-icon">ğŸ“–</span>
                <span>ä½¿ç”¨è¯´æ˜</span>
            </div>
        </div>

        <div class="content">
            <!-- å¿«æ·é”®è®¾ç½® -->
            <div id="shortcut" class="section">
                <h2 class="section-title">å¿«æ·é”®</h2>
                <p class="section-desc">è®¾ç½®è§¦å‘å½•éŸ³çš„å¿«æ·é”®</p>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">å½“å‰å¿«æ·é”®</label>
                        <div class="shortcut-display">
                            <span id="current-shortcut" class="shortcut-key">Right Command</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è®¾ç½®æ–°å¿«æ·é”®</label>
                        <button id="record-shortcut-btn" class="btn btn-primary shortcut-record-btn">
                            ç‚¹å‡»å½•åˆ¶
                        </button>
                        <p class="form-hint">ç‚¹å‡»æŒ‰é’®åï¼ŒæŒ‰ä¸‹å¿«æ·é”®ç»„åˆï¼ˆå¦‚ Ctrl+Shift+Aï¼‰ï¼Œæ¾å¼€éä¿®é¥°é”®å®Œæˆå½•åˆ¶</p>
                        <p class="form-hint" style="color: #ff9500;">æŒ‰ Esc å–æ¶ˆå½•åˆ¶</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ä½¿ç”¨è¯´æ˜</div>
                    <div class="help-content">
                        <p><strong>å•å‡»</strong>ï¼šå¼€å§‹/åœæ­¢å½•éŸ³</p>
                        <p><strong>åŒå‡»</strong>ï¼ˆé—´éš” &lt; 0.4ç§’ï¼‰ï¼šç”¨å‰ªè´´æ¿å†…å®¹æ›´æ–°æœ€æ–°å†å²</p>
                    </div>
                </div>
            </div>

            <!-- éº¦å…‹é£è®¾ç½® -->
            <div id="microphone" class="section">
                <h2 class="section-title">éº¦å…‹é£</h2>
                <p class="section-desc">é€‰æ‹©éŸ³é¢‘è¾“å…¥è®¾å¤‡</p>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">è¾“å…¥è®¾å¤‡</label>
                        <select id="microphone-select" class="form-select">
                            <option value="">è‡ªåŠ¨ï¼ˆè·Ÿéšç³»ç»Ÿï¼‰</option>
                        </select>
                        <p class="form-hint">é€‰æ‹©ç”¨äºè¯­éŸ³è¾“å…¥çš„éº¦å…‹é£è®¾å¤‡</p>
                    </div>
                </div>
            </div>

            <!-- å½•éŸ³è®¾ç½® -->
            <div id="recording" class="section">
                <h2 class="section-title">å½•éŸ³è®¾ç½®</h2>
                <p class="section-desc">é…ç½®å½•éŸ³è¶…æ—¶å’Œè‡ªåŠ¨åœæ­¢è¡Œä¸º</p>

                <div class="card">
                    <div class="card-title">è‡ªåŠ¨åœæ­¢</div>

                    <div class="form-group">
                        <label class="form-label">æœ€é•¿å½•éŸ³æ—¶é•¿</label>
                        <div class="ttl-selector">
                            <input type="range" id="max-duration-slider" class="form-range" min="10" max="120" step="10" value="60">
                            <span id="max-duration-value" class="ttl-value">60 ç§’</span>
                        </div>
                        <p class="form-hint">è¶…è¿‡æ­¤æ—¶é•¿å°†è‡ªåŠ¨åœæ­¢å½•éŸ³å¹¶è¿›è¡Œè¯†åˆ«ï¼ˆ10-120 ç§’ï¼‰</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é™éŸ³è¶…æ—¶æ—¶é—´</label>
                        <div class="ttl-selector">
                            <input type="range" id="silence-timeout-slider" class="form-range" min="2" max="10" step="1" value="3">
                            <span id="silence-timeout-value" class="ttl-value">3 ç§’</span>
                        </div>
                        <p class="form-hint">å¼€å§‹å½•éŸ³åå¦‚æœæŒç»­é™éŸ³è¶…è¿‡æ­¤æ—¶é•¿ï¼Œå°†è‡ªåŠ¨å–æ¶ˆå½•éŸ³ï¼ˆ2-10 ç§’ï¼‰</p>
                    </div>
                </div>
            </div>

            <!-- è¯­éŸ³è¯†åˆ«æ¨¡å‹è®¾ç½® -->
            <div id="asr" class="section">
                <h2 class="section-title">è¯­éŸ³è¯†åˆ«æ¨¡å‹</h2>
                <p class="section-desc">é…ç½®è¯­éŸ³è¯†åˆ«æœåŠ¡</p>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" id="api-key" class="form-input" placeholder="è¯·è¾“å…¥ API Key">
                        <p class="form-hint">é˜¿é‡Œäº‘ DashScope API Keyï¼Œç•™ç©ºåˆ™ä½¿ç”¨ç¯å¢ƒå˜é‡ DASHSCOPE_API_KEY</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹</label>
                        <select id="asr-model" class="form-select">
                            <option value="qwen3-asr-flash">qwen3-asr-flashï¼ˆæ¨èï¼‰</option>
                            <option value="qwen2-audio-instruct">qwen2-audio-instruct</option>
                        </select>
                        <p class="form-hint">é€‰æ‹©è¯­éŸ³è¯†åˆ«æ¨¡å‹</p>
                    </div>
                </div>
            </div>

            <!-- å¤§è¯­è¨€æ¨¡å‹è®¾ç½® -->
            <div id="llm" class="section active">
                <h2 class="section-title">å¤§è¯­è¨€æ¨¡å‹</h2>
                <p class="section-desc">é…ç½® LLM æœåŠ¡å’Œè¯­éŸ³çº é”™åŠŸèƒ½</p>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" id="llm-api-key" class="form-input" placeholder="è¯·è¾“å…¥ API Key">
                        <p class="form-hint">DeepSeek API Keyï¼Œç•™ç©ºåˆ™ä½¿ç”¨ç¯å¢ƒå˜é‡ DEEPSEEK_API_KEY</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹æä¾›å•†</label>
                        <select id="llm-provider" class="form-select">
                            <option value="deepseek">DeepSeek</option>
                        </select>
                        <p class="form-hint">é€‰æ‹©å¤§è¯­è¨€æ¨¡å‹æä¾›å•†</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹</label>
                        <select id="llm-model" class="form-select">
                            <option value="deepseek-chat">deepseek-chat</option>
                            <option value="deepseek-reasoner">deepseek-reasoner</option>
                        </select>
                        <p class="form-hint">é€‰æ‹©å…·ä½“æ¨¡å‹</p>
                    </div>

                    <div class="form-group">
                        <button id="test-llm-btn" class="btn btn-primary" disabled>æµ‹è¯• API è¿æ¥</button>
                        <div id="test-result" class="test-result"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">è¯­éŸ³çº é”™</div>

                    <div class="form-group">
                        <div class="toggle-container">
                            <span class="toggle-label">å¯ç”¨çº é”™åŠŸèƒ½</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="llm-correction-enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p class="form-hint" id="correction-hint">å¼€å¯åï¼Œè¯­éŸ³è¯†åˆ«ç»“æœä¼šç»è¿‡ LLM è¿›è¡Œçº é”™</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">çº é”™æç¤ºè¯</label>
                        <textarea id="llm-correction-prompt" class="form-textarea" placeholder="è¯·è¾“å…¥çº é”™æç¤ºè¯"></textarea>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ä¸Šä¸‹æ–‡çº é”™</div>

                    <div class="form-group">
                        <div class="toggle-container">
                            <span class="toggle-label">å¯ç”¨ä¸Šä¸‹æ–‡çº é”™</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="context-correction-enabled">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p class="form-hint" id="context-correction-hint">æ ¹æ®å†å²å¯¹è¯ä¸Šä¸‹æ–‡çº æ­£å½“å‰è¯†åˆ«ç»“æœ</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è§‚å¯Ÿå†å²æ¶ˆæ¯æ•°é‡</label>
                        <div class="window-size-selector" id="window-size-selector">
                            <button class="window-size-btn" data-size="1">1</button>
                            <button class="window-size-btn" data-size="2">2</button>
                            <button class="window-size-btn" data-size="3">3</button>
                            <button class="window-size-btn" data-size="4">4</button>
                            <button class="window-size-btn" data-size="5">5</button>
                            <button class="window-size-btn" data-size="6">6</button>
                            <button class="window-size-btn" data-size="7">7</button>
                            <button class="window-size-btn" data-size="8">8</button>
                            <button class="window-size-btn" data-size="9">9</button>
                            <button class="window-size-btn" data-size="10">10</button>
                        </div>
                        <p class="form-hint">é€‰æ‹©ç”¨äºçº é”™å‚è€ƒçš„å†å²æ¶ˆæ¯æ¡æ•°ï¼ˆ1-10ï¼‰</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å†å²æ¶ˆæ¯æœ‰æ•ˆæœŸ</label>
                        <div class="ttl-selector">
                            <input type="range" id="history-ttl-slider" class="form-range" min="5" max="60" step="5" value="10">
                            <span id="history-ttl-value" class="ttl-value">10 åˆ†é’Ÿ</span>
                        </div>
                        <p class="form-hint">è¶…è¿‡æœ‰æ•ˆæœŸçš„å†å²æ¶ˆæ¯ä¸ä¼šç”¨äºä¸Šä¸‹æ–‡çº é”™ï¼ˆ5-60 åˆ†é’Ÿï¼‰</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä¸Šä¸‹æ–‡çº é”™æç¤ºè¯</label>
                        <textarea id="context-correction-prompt" class="form-textarea" placeholder="è¯·è¾“å…¥ä¸Šä¸‹æ–‡çº é”™æç¤ºè¯"></textarea>
                        <p class="form-hint">ä½¿ç”¨ {history} å’Œ {current} ä½œä¸ºå ä½ç¬¦</p>
                    </div>

                    <div class="form-group">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <label class="form-label" style="margin-bottom: 0;">å†å²æ¶ˆæ¯</label>
                            <button id="refresh-history-btn" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">åˆ·æ–°</button>
                        </div>
                        <div class="history-list" id="history-list">
                            <div class="history-empty">æš‚æ— å†å²æ¶ˆæ¯</div>
                        </div>
                        <button id="clear-history-btn" class="btn btn-danger clear-all-btn" style="display: none;">æ¸…ç©ºå…¨éƒ¨</button>
                    </div>
                </div>
            </div>

            <!-- ä½¿ç”¨ç»Ÿè®¡ -->
            <div id="stats" class="section">
                <h2 class="section-title">ä½¿ç”¨ç»Ÿè®¡</h2>
                <p class="section-desc">æŸ¥çœ‹è¯­éŸ³è¾“å…¥ä½¿ç”¨æƒ…å†µ</p>

                <div class="card">
                    <div class="stats-summary">
                        <div class="stat-item">
                            <span class="stat-value" id="total-chars">0</span>
                            <span class="stat-label">æ€»è¾“å…¥å­—æ•°</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="total-count">0</span>
                            <span class="stat-label">æ¶ˆæ¯æ¡æ•°</span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">å†å²æ¶ˆæ¯</div>
                    <div class="stats-history-list" id="stats-history-list">
                        <!-- åŠ¨æ€åŠ è½½ -->
                    </div>
                    <div id="stats-loading" class="stats-loading" style="display: none;">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- ä½¿ç”¨è¯´æ˜ -->
            <div id="help" class="section">
                <h2 class="section-title">ä½¿ç”¨è¯´æ˜</h2>
                <p class="section-desc">å¿«é€Ÿä¸Šæ‰‹è¯­éŸ³è¾“å…¥</p>

                <div class="card">
                    <div class="card-title">åŸºæœ¬æ“ä½œ</div>
                    <div class="help-content">
                        <p><strong>1. å¼€å§‹å½•éŸ³</strong></p>
                        <p>æŒ‰ä¸‹å½•éŸ³å¿«æ·é”®ï¼ˆé»˜è®¤ Right Commandï¼‰å¼€å§‹å½•éŸ³ï¼ŒçŠ¶æ€æ å›¾æ ‡å˜ä¸ºéº¦å…‹é£ã€‚</p>

                        <p><strong>2. åœæ­¢å½•éŸ³</strong></p>
                        <p>å†æ¬¡æŒ‰ä¸‹å¿«æ·é”®åœæ­¢å½•éŸ³ï¼Œç³»ç»Ÿè‡ªåŠ¨è¿›è¡Œè¯­éŸ³è¯†åˆ«ã€‚</p>

                        <p><strong>3. æ–‡å­—è¾“å…¥</strong></p>
                        <p>è¯†åˆ«å®Œæˆåï¼Œæ–‡å­—ä¼šè‡ªåŠ¨è¾“å…¥åˆ°å½“å‰å…‰æ ‡ä½ç½®ã€‚</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">åŒå‡»æ›´æ–°å†å²</div>
                    <div class="help-content">
                        <p>å½“è¯­éŸ³è¯†åˆ«ç»“æœæœ‰è¯¯æ—¶ï¼š</p>
                        <ol>
                            <li>æ‰‹åŠ¨ä¿®æ”¹è¯†åˆ«ç»“æœ</li>
                            <li>å¤åˆ¶ä¿®æ”¹åçš„æ–‡æœ¬</li>
                            <li>å¿«é€ŸåŒå‡»å½•éŸ³å¿«æ·é”®ï¼ˆé—´éš” &lt; 0.4ç§’ï¼‰</li>
                            <li>ç³»ç»Ÿä¼šç”¨å‰ªè´´æ¿å†…å®¹æ›´æ–°å†å²ä¸­æœ€æ–°çš„ä¸€æ¡æ¶ˆæ¯</li>
                        </ol>
                        <p>è¿™æ ·å¯ä»¥ç¡®ä¿ä¸Šä¸‹æ–‡çº é”™åŠŸèƒ½ä½¿ç”¨æ­£ç¡®çš„å†å²è®°å½•ã€‚</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">çº é”™åŠŸèƒ½</div>
                    <div class="help-content">
                        <p><strong>è¯­éŸ³çº é”™</strong></p>
                        <p>å¼€å¯åï¼Œè¯†åˆ«ç»“æœä¼šç»è¿‡å¤§è¯­è¨€æ¨¡å‹çº æ­£é”™åˆ«å­—ã€è¯­æ³•å’Œæ ‡ç‚¹ã€‚</p>

                        <p><strong>ä¸Šä¸‹æ–‡çº é”™</strong></p>
                        <p>æ ¹æ®å†å²å¯¹è¯ä¸Šä¸‹æ–‡ï¼Œçº æ­£ä¸“æœ‰åè¯ã€äººåç­‰å®¹æ˜“è¯†åˆ«é”™è¯¯çš„è¯æ±‡ã€‚</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ç³»ç»Ÿæƒé™</div>
                    <div class="help-content">
                        <p>åº”ç”¨éœ€è¦ä»¥ä¸‹æƒé™æ‰èƒ½æ­£å¸¸å·¥ä½œï¼š</p>
                        <ul>
                            <li><strong>éº¦å…‹é£æƒé™</strong> - å½•åˆ¶è¯­éŸ³</li>
                            <li><strong>è¾…åŠ©åŠŸèƒ½æƒé™</strong> - æ¨¡æ‹Ÿé”®ç›˜è¾“å…¥æ–‡å­—</li>
                            <li><strong>è¾“å…¥ç›‘æ§æƒé™</strong> - ç›‘å¬å¿«æ·é”®</li>
                        </ul>
                        <p>è¯·åœ¨ ç³»ç»Ÿè®¾ç½® â†’ éšç§ä¸å®‰å…¨æ€§ ä¸­æˆäºˆç›¸åº”æƒé™ã€‚</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å†å²æ¶ˆæ¯æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">ç¼–è¾‘å†å²æ¶ˆæ¯</div>
            <textarea id="edit-history-text" class="form-textarea" style="min-height: 80px;"></textarea>
            <div class="modal-actions">
                <button id="cancel-edit-btn" class="btn btn-secondary">å–æ¶ˆ</button>
                <button id="save-edit-btn" class="btn btn-primary">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">å·²ä¿å­˜</div>

    <script>
        // å¯¼èˆªåˆ‡æ¢
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                // æ›´æ–°å¯¼èˆªçŠ¶æ€
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');

                // åˆ‡æ¢å†…å®¹åŒº
                const sectionId = item.dataset.section;
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');

                // åˆ‡æ¢åˆ°ä½¿ç”¨ç»Ÿè®¡æ—¶åŠ è½½æ•°æ®
                if (sectionId === 'stats') {
                    loadUsageStats(true);  // é‡ç½®å¹¶åŠ è½½
                }
            });
        });

        // ========== ä½¿ç”¨ç»Ÿè®¡ç›¸å…³ ==========
        let statsCurrentPage = 0;
        let statsHasMore = true;
        let statsLoading = false;

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatTime(isoString) {
            if (!isoString || isoString === '1970-01-01T00:00:00') {
                return 'æœªçŸ¥æ—¶é—´';
            }
            const date = new Date(isoString);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const time = `${hours}:${minutes}`;

            if (msgDate.getTime() === today.getTime()) {
                return `ä»Šå¤© ${time}`;
            } else if (msgDate.getTime() === yesterday.getTime()) {
                return `æ˜¨å¤© ${time}`;
            } else if (date.getFullYear() === now.getFullYear()) {
                return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${time}`;
            } else {
                return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${time}`;
            }
        }

        // åŠ è½½ä½¿ç”¨ç»Ÿè®¡
        async function loadUsageStats(reset = false) {
            if (statsLoading) return;
            if (!reset && !statsHasMore) return;

            if (reset) {
                statsCurrentPage = 0;
                statsHasMore = true;
                document.getElementById('stats-history-list').innerHTML = '';
            }

            statsLoading = true;
            document.getElementById('stats-loading').style.display = 'block';

            try {
                const response = await fetch(`/api/usage-stats?page=${statsCurrentPage}&page_size=20`);
                const data = await response.json();

                // æ›´æ–°ç»Ÿè®¡æ•°å­—
                document.getElementById('total-chars').textContent = data.total_chars.toLocaleString();
                document.getElementById('total-count').textContent = data.total_count.toLocaleString();

                // æ¸²æŸ“å†å²æ¶ˆæ¯
                const listEl = document.getElementById('stats-history-list');
                if (data.total_count === 0 && statsCurrentPage === 0) {
                    listEl.innerHTML = '<div class="stats-empty">æš‚æ— å†å²æ¶ˆæ¯</div>';
                } else {
                    const html = data.history.map((item, idx) => {
                        const globalIdx = 'stats-' + (statsCurrentPage * 20 + idx);
                        const status = item.status;
                        const hasVersionInfo = item.original && (status === 'auto' || status === 'manual' || status === 'unchanged');
                        return `
                            <div class="stats-history-item">
                                <div class="stats-history-text">
                                    ${escapeHtml(item.text)}
                                    ${getStatusBadge(status, item.original, item.corrected)}
                                    ${hasVersionInfo ? `<button class="expand-btn" onclick="toggleVersionDetails('${globalIdx}')">è¯¦æƒ…</button>` : ''}
                                </div>
                                <div class="stats-history-time">${formatTime(item.timestamp)}</div>
                                ${getVersionDetailsForStats(item, globalIdx)}
                            </div>
                        `;
                    }).join('');
                    listEl.insertAdjacentHTML('beforeend', html);
                }

                statsHasMore = data.has_more;
                statsCurrentPage++;
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
            } finally {
                statsLoading = false;
                document.getElementById('stats-loading').style.display = 'none';
            }
        }

        // ç›‘å¬ç»Ÿè®¡å†å²åˆ—è¡¨æ»šåŠ¨
        document.addEventListener('DOMContentLoaded', () => {
            const statsListEl = document.getElementById('stats-history-list');
            statsListEl.addEventListener('scroll', () => {
                if (statsListEl.scrollTop + statsListEl.clientHeight >= statsListEl.scrollHeight - 50) {
                    loadUsageStats();
                }
            });
        });

        // æ˜¾ç¤ºä¿å­˜æç¤º
        function showToast(message = 'å·²ä¿å­˜') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                // åŠ è½½éº¦å…‹é£åˆ—è¡¨
                const micsResponse = await fetch('/api/microphones');
                const microphones = await micsResponse.json();

                const micSelect = document.getElementById('microphone-select');
                micSelect.innerHTML = '';
                microphones.forEach(mic => {
                    const option = document.createElement('option');
                    option.value = mic.id === null ? '' : mic.id;
                    option.textContent = mic.name;
                    micSelect.appendChild(option);
                });

                // åŠ è½½å½“å‰é…ç½®
                const configResponse = await fetch('/api/config');
                const config = await configResponse.json();

                // è®¾ç½®éº¦å…‹é£é€‰é¡¹
                const deviceId = config.microphone.device_id;
                micSelect.value = deviceId === null ? '' : deviceId;

                // è®¾ç½® API Key
                const apiKeyInput = document.getElementById('api-key');
                if (config.asr.api_key_set) {
                    apiKeyInput.placeholder = 'å·²è®¾ç½®ï¼ˆè¾“å…¥æ–°å€¼è¦†ç›–ï¼‰';
                }

                // è®¾ç½®æ¨¡å‹
                document.getElementById('asr-model').value = config.asr.model;

                // è®¾ç½®å½•éŸ³é…ç½®
                const maxDuration = config.recording?.max_duration || 60;
                document.getElementById('max-duration-slider').value = maxDuration;
                document.getElementById('max-duration-value').textContent = maxDuration + ' ç§’';

                const silenceTimeout = config.recording?.silence_timeout || 3;
                document.getElementById('silence-timeout-slider').value = silenceTimeout;
                document.getElementById('silence-timeout-value').textContent = silenceTimeout + ' ç§’';

                // è®¾ç½® LLM é…ç½®
                const llmApiKeyInput = document.getElementById('llm-api-key');
                if (config.llm.api_key_set) {
                    llmApiKeyInput.placeholder = 'å·²è®¾ç½®ï¼ˆè¾“å…¥æ–°å€¼è¦†ç›–ï¼‰';
                }
                document.getElementById('llm-provider').value = config.llm.provider;
                document.getElementById('llm-model').value = config.llm.model;
                document.getElementById('llm-correction-prompt').value = config.llm.correction_prompt;

                // æ ¹æ® API Key æ˜¯å¦è®¾ç½®æ¥å¯ç”¨/ç¦ç”¨çº é”™å¼€å…³å’Œæµ‹è¯•æŒ‰é’®
                const correctionToggle = document.getElementById('llm-correction-enabled');
                const correctionHint = document.getElementById('correction-hint');
                const testBtn = document.getElementById('test-llm-btn');
                const contextCorrectionToggle = document.getElementById('context-correction-enabled');
                const contextCorrectionHint = document.getElementById('context-correction-hint');

                if (config.llm.api_key_set) {
                    correctionToggle.disabled = false;
                    correctionToggle.checked = config.llm.correction_enabled;
                    correctionHint.textContent = 'å¼€å¯åï¼Œè¯­éŸ³è¯†åˆ«ç»“æœä¼šç»è¿‡ LLM è¿›è¡Œçº é”™';
                    testBtn.disabled = false;
                    contextCorrectionToggle.disabled = false;
                    contextCorrectionToggle.checked = config.llm.context_correction_enabled;
                    contextCorrectionHint.textContent = 'æ ¹æ®å†å²å¯¹è¯ä¸Šä¸‹æ–‡çº æ­£å½“å‰è¯†åˆ«ç»“æœ';
                } else {
                    correctionToggle.disabled = true;
                    correctionToggle.checked = false;
                    correctionHint.textContent = 'è¯·å…ˆè®¾ç½® API Key åå†å¼€å¯çº é”™åŠŸèƒ½';
                    testBtn.disabled = true;
                    contextCorrectionToggle.disabled = true;
                    contextCorrectionToggle.checked = false;
                    contextCorrectionHint.textContent = 'è¯·å…ˆè®¾ç½® API Key åå†å¼€å¯ä¸Šä¸‹æ–‡çº é”™';
                }

                // è®¾ç½®ä¸Šä¸‹æ–‡çª—å£å¤§å°
                const windowSize = config.llm.context_window_size || 5;
                document.querySelectorAll('.window-size-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.size) === windowSize);
                });

                // è®¾ç½®ä¸Šä¸‹æ–‡çº é”™æç¤ºè¯
                document.getElementById('context-correction-prompt').value = config.llm.context_correction_prompt || '';

                // è®¾ç½®å†å²æœ‰æ•ˆæœŸæ»‘å—
                const ttl = config.llm.context_history_ttl || 10;
                document.getElementById('history-ttl-slider').value = ttl;
                document.getElementById('history-ttl-value').textContent = ttl + ' åˆ†é’Ÿ';

                // æ¸²æŸ“å†å²æ¶ˆæ¯åˆ—è¡¨
                renderHistoryList(config.context_history || [], windowSize);

            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // å½“å‰çª—å£å¤§å°ï¼ˆç”¨äºé«˜äº®æ˜¾ç¤ºï¼‰
        let currentWindowSize = 5;

        // è·å–çŠ¶æ€æ ‡ç­¾ HTML
        function getStatusBadge(status, original, corrected) {
            if (!status || status === 'none') return '';
            const labels = {
                'auto': 'è‡ªåŠ¨çº æ­£',
                'manual': 'æ‰‹åŠ¨ä¿®æ”¹',
                'unchanged': 'æ— å˜åŒ–'
            };
            return `<span class="status-badge ${status}">${labels[status] || status}</span>`;
        }

        // è·å–ç‰ˆæœ¬è¯¦æƒ… HTML
        function getVersionDetails(item, idx) {
            const hasVersionInfo = item.original || item.corrected;
            if (!hasVersionInfo) return '';

            const original = item.original || item.text;
            const corrected = item.corrected;
            const text = item.text;

            let detailsHtml = `<div class="version-details" id="version-details-${idx}">`;
            detailsHtml += `<div class="version-row"><span class="version-label">åŸå§‹:</span><span class="version-text">${escapeHtml(original)}</span></div>`;

            if (corrected && corrected !== original) {
                detailsHtml += `<div class="version-row"><span class="version-label">çº æ­£:</span><span class="version-text changed">${escapeHtml(corrected)}</span></div>`;
            }

            if (text !== corrected && text !== original) {
                detailsHtml += `<div class="version-row"><span class="version-label">æœ€ç»ˆ:</span><span class="version-text changed">${escapeHtml(text)}</span></div>`;
            }

            detailsHtml += '</div>';
            return detailsHtml;
        }

        // åˆ‡æ¢ç‰ˆæœ¬è¯¦æƒ…å±•å¼€
        function toggleVersionDetails(idx) {
            const el = document.getElementById('version-details-' + idx);
            if (el) {
                el.classList.toggle('show');
            }
        }

        // è·å–ç»Ÿè®¡é¡µé¢ç‰ˆæœ¬è¯¦æƒ… HTML
        function getVersionDetailsForStats(item, idx) {
            const hasVersionInfo = item.original || item.corrected;
            if (!hasVersionInfo) return '';

            const original = item.original || item.text;
            const corrected = item.corrected;
            const text = item.text;

            let detailsHtml = `<div class="version-details" id="version-details-${idx}" style="margin-top: 8px;">`;
            detailsHtml += `<div class="version-row"><span class="version-label">åŸå§‹:</span><span class="version-text">${escapeHtml(original)}</span></div>`;

            if (corrected && corrected !== original) {
                detailsHtml += `<div class="version-row"><span class="version-label">çº æ­£:</span><span class="version-text changed">${escapeHtml(corrected)}</span></div>`;
            }

            if (text !== corrected && text !== original) {
                detailsHtml += `<div class="version-row"><span class="version-label">æœ€ç»ˆ:</span><span class="version-text changed">${escapeHtml(text)}</span></div>`;
            }

            detailsHtml += '</div>';
            return detailsHtml;
        }

        // æ¸²æŸ“å†å²æ¶ˆæ¯åˆ—è¡¨ï¼ˆæ˜¾ç¤ºçª—å£èŒƒå›´å†…çš„æ¶ˆæ¯ï¼‰
        function renderHistoryList(history, windowSize) {
            currentWindowSize = windowSize;
            const listEl = document.getElementById('history-list');
            const clearBtn = document.getElementById('clear-history-btn');

            if (!history || history.length === 0) {
                listEl.innerHTML = '<div class="history-empty">æš‚æ— å†å²æ¶ˆæ¯</div>';
                clearBtn.style.display = 'none';
                return;
            }

            clearBtn.style.display = 'block';

            // history å·²ç»æ˜¯çª—å£èŒƒå›´å†…çš„æ¶ˆæ¯ï¼ˆç”±åç«¯è¿”å›ï¼‰
            listEl.innerHTML = history.map((item, i) => {
                const text = item.text;
                const timestamp = item.timestamp;
                const status = item.status;
                const hasVersionInfo = item.original && (item.status === 'auto' || item.status === 'manual' || item.status === 'unchanged');

                return `
                    <div class="history-item" style="flex-direction: column; align-items: stretch;">
                        <div style="display: flex; align-items: center;">
                            <span class="history-text in-window" title="${escapeHtml(text)}">${escapeHtml(text)}</span>
                            ${getStatusBadge(status, item.original, item.corrected)}
                            ${hasVersionInfo ? `<button class="expand-btn" onclick="toggleVersionDetails(${i})">è¯¦æƒ…</button>` : ''}
                            <div class="history-actions">
                                <button class="history-btn" onclick="editHistory('${escapeHtml(timestamp)}')">ç¼–è¾‘</button>
                                <button class="history-btn delete" onclick="deleteHistory('${escapeHtml(timestamp)}')">åˆ é™¤</button>
                            </div>
                        </div>
                        ${getVersionDetails(item, i)}
                    </div>
                `;
            }).join('');
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ç¼–è¾‘å†å²æ¶ˆæ¯
        let editingTimestamp = '';
        function editHistory(timestamp) {
            editingTimestamp = timestamp;
            fetch('/api/context-history')
                .then(res => res.json())
                .then(data => {
                    const history = data.history || [];
                    const item = history.find(h => h.timestamp === timestamp);
                    if (item) {
                        document.getElementById('edit-history-text').value = item.text;
                        document.getElementById('edit-modal').classList.add('show');
                    }
                });
        }

        // åˆ é™¤å†å²æ¶ˆæ¯
        async function deleteHistory(timestamp) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;

            try {
                await fetch(`/api/context-history/${encodeURIComponent(timestamp)}`, { method: 'DELETE' });
                showToast('å·²åˆ é™¤');
                // é‡æ–°åŠ è½½å†å²
                const res = await fetch('/api/config');
                const config = await res.json();
                renderHistoryList(config.context_history || [], currentWindowSize);
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥');
            }
        }

        // æ¸…ç©ºæ‰€æœ‰å†å²
        async function clearAllHistory() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²æ¶ˆæ¯å—ï¼Ÿ')) return;

            try {
                await fetch('/api/context-history', { method: 'DELETE' });
                showToast('å·²æ¸…ç©º');
                renderHistoryList([], currentWindowSize);
            } catch (error) {
                showToast('æ¸…ç©ºå¤±è´¥');
            }
        }

        // ä¿å­˜ç¼–è¾‘çš„å†å²æ¶ˆæ¯
        async function saveEditedHistory() {
            const newText = document.getElementById('edit-history-text').value;
            if (!newText.trim()) {
                showToast('æ¶ˆæ¯ä¸èƒ½ä¸ºç©º');
                return;
            }

            try {
                await fetch(`/api/context-history/${encodeURIComponent(editingTimestamp)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: newText })
                });
                showToast('å·²ä¿å­˜');
                document.getElementById('edit-modal').classList.remove('show');
                // é‡æ–°åŠ è½½å†å²
                const res = await fetch('/api/config');
                const config = await res.json();
                renderHistoryList(config.context_history || [], currentWindowSize);
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥');
            }
        }

        // ä¿å­˜éº¦å…‹é£è®¾ç½®
        async function saveMicrophone() {
            const select = document.getElementById('microphone-select');
            const deviceId = select.value === '' ? null : parseInt(select.value);
            const deviceName = select.options[select.selectedIndex].text;

            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        microphone: {
                            device_id: deviceId,
                            device_name: deviceName
                        }
                    })
                });
                showToast();
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥');
            }
        }

        // ä¿å­˜ ASR è®¾ç½®
        async function saveASR(field) {
            const data = { asr: {} };

            if (field === 'api_key') {
                const value = document.getElementById('api-key').value;
                if (value) {
                    data.asr.api_key = value;
                } else {
                    return; // ç©ºå€¼ä¸ä¿å­˜
                }
            } else if (field === 'model') {
                data.asr.model = document.getElementById('asr-model').value;
            }

            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast();

                // æ›´æ–° placeholder
                if (field === 'api_key') {
                    document.getElementById('api-key').value = '';
                    document.getElementById('api-key').placeholder = 'å·²è®¾ç½®ï¼ˆè¾“å…¥æ–°å€¼è¦†ç›–ï¼‰';
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥');
            }
        }

        // ä¿å­˜ LLM è®¾ç½®
        async function saveLLM(field, value) {
            const data = { llm: {} };

            if (field === 'api_key') {
                const val = document.getElementById('llm-api-key').value;
                if (val) {
                    data.llm.api_key = val;
                } else {
                    return; // ç©ºå€¼ä¸ä¿å­˜
                }
            } else if (field === 'provider') {
                data.llm.provider = document.getElementById('llm-provider').value;
            } else if (field === 'model') {
                data.llm.model = document.getElementById('llm-model').value;
            } else if (field === 'correction_enabled') {
                data.llm.correction_enabled = document.getElementById('llm-correction-enabled').checked;
            } else if (field === 'correction_prompt') {
                data.llm.correction_prompt = document.getElementById('llm-correction-prompt').value;
            } else if (field === 'context_correction_enabled') {
                data.llm.context_correction_enabled = document.getElementById('context-correction-enabled').checked;
            } else if (field === 'context_window_size') {
                data.llm.context_window_size = value;
            } else if (field === 'context_history_ttl') {
                data.llm.context_history_ttl = value;
            } else if (field === 'context_correction_prompt') {
                data.llm.context_correction_prompt = document.getElementById('context-correction-prompt').value;
            }

            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast();

                // æ›´æ–° placeholder
                if (field === 'api_key') {
                    document.getElementById('llm-api-key').value = '';
                    document.getElementById('llm-api-key').placeholder = 'å·²è®¾ç½®ï¼ˆè¾“å…¥æ–°å€¼è¦†ç›–ï¼‰';
                    // å¯ç”¨çº é”™å¼€å…³å’Œæµ‹è¯•æŒ‰é’®
                    document.getElementById('llm-correction-enabled').disabled = false;
                    document.getElementById('correction-hint').textContent = 'å¼€å¯åï¼Œè¯­éŸ³è¯†åˆ«ç»“æœä¼šç»è¿‡ LLM è¿›è¡Œçº é”™';
                    document.getElementById('test-llm-btn').disabled = false;
                    // å¯ç”¨ä¸Šä¸‹æ–‡çº é”™å¼€å…³
                    document.getElementById('context-correction-enabled').disabled = false;
                    document.getElementById('context-correction-hint').textContent = 'æ ¹æ®å†å²å¯¹è¯ä¸Šä¸‹æ–‡çº æ­£å½“å‰è¯†åˆ«ç»“æœ';
                }

                // æ›´æ–°çª—å£å¤§å°æ—¶ï¼Œé‡æ–°æ¸²æŸ“å†å²åˆ—è¡¨
                if (field === 'context_window_size') {
                    currentWindowSize = value;
                    const res = await fetch('/api/config');
                    const config = await res.json();
                    renderHistoryList(config.context_history || [], value);
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥');
            }
        }

        // æµ‹è¯• LLM API è¿æ¥
        async function testLLM() {
            const btn = document.getElementById('test-llm-btn');
            const result = document.getElementById('test-result');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            result.className = 'test-result loading';
            result.textContent = 'æ­£åœ¨è¿æ¥ API...';

            try {
                const response = await fetch('/api/llm/test', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    result.className = 'test-result success';
                    result.textContent = 'âœ“ è¿æ¥æˆåŠŸï¼š' + data.message;
                } else {
                    result.className = 'test-result error';
                    result.textContent = 'âœ— è¿æ¥å¤±è´¥ï¼š' + data.message;
                }
            } catch (error) {
                result.className = 'test-result error';
                result.textContent = 'âœ— è¯·æ±‚å¤±è´¥ï¼š' + error.message;
            } finally {
                btn.disabled = false;
                btn.textContent = 'æµ‹è¯• API è¿æ¥';
            }
        }

        // ä¿å­˜å½•éŸ³è®¾ç½®
        async function saveRecording(field, value) {
            const data = { recording: {} };

            if (field === 'max_duration') {
                data.recording.max_duration = value;
            } else if (field === 'silence_timeout') {
                data.recording.silence_timeout = value;
            }

            try {
                await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                showToast();
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥');
            }
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('microphone-select').addEventListener('change', saveMicrophone);
        document.getElementById('api-key').addEventListener('blur', () => saveASR('api_key'));
        document.getElementById('asr-model').addEventListener('change', () => saveASR('model'));

        // å½•éŸ³è®¾ç½®äº‹ä»¶ç»‘å®š
        const maxDurationSlider = document.getElementById('max-duration-slider');
        const maxDurationValue = document.getElementById('max-duration-value');
        maxDurationSlider.addEventListener('input', () => {
            maxDurationValue.textContent = maxDurationSlider.value + ' ç§’';
        });
        maxDurationSlider.addEventListener('change', () => {
            saveRecording('max_duration', parseInt(maxDurationSlider.value));
        });

        const silenceTimeoutSlider = document.getElementById('silence-timeout-slider');
        const silenceTimeoutValue = document.getElementById('silence-timeout-value');
        silenceTimeoutSlider.addEventListener('input', () => {
            silenceTimeoutValue.textContent = silenceTimeoutSlider.value + ' ç§’';
        });
        silenceTimeoutSlider.addEventListener('change', () => {
            saveRecording('silence_timeout', parseInt(silenceTimeoutSlider.value));
        });

        // LLM äº‹ä»¶ç»‘å®š
        document.getElementById('llm-api-key').addEventListener('blur', () => saveLLM('api_key'));
        document.getElementById('llm-provider').addEventListener('change', () => saveLLM('provider'));
        document.getElementById('llm-model').addEventListener('change', () => saveLLM('model'));
        document.getElementById('llm-correction-enabled').addEventListener('change', () => saveLLM('correction_enabled'));
        document.getElementById('llm-correction-prompt').addEventListener('blur', () => saveLLM('correction_prompt'));
        document.getElementById('test-llm-btn').addEventListener('click', testLLM);

        // ä¸Šä¸‹æ–‡çº é”™äº‹ä»¶ç»‘å®š
        document.getElementById('context-correction-enabled').addEventListener('change', () => saveLLM('context_correction_enabled'));
        document.getElementById('context-correction-prompt').addEventListener('blur', () => saveLLM('context_correction_prompt'));

        // å†å²æœ‰æ•ˆæœŸæ»‘å—äº‹ä»¶ç»‘å®š
        const ttlSlider = document.getElementById('history-ttl-slider');
        const ttlValue = document.getElementById('history-ttl-value');
        ttlSlider.addEventListener('input', () => {
            ttlValue.textContent = ttlSlider.value + ' åˆ†é’Ÿ';
        });
        ttlSlider.addEventListener('change', () => {
            saveLLM('context_history_ttl', parseInt(ttlSlider.value));
        });

        // çª—å£å¤§å°é€‰æ‹©
        document.querySelectorAll('.window-size-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const size = parseInt(btn.dataset.size);
                document.querySelectorAll('.window-size-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                saveLLM('context_window_size', size);
            });
        });

        // åˆ·æ–°å†å²æŒ‰é’®
        document.getElementById('refresh-history-btn').addEventListener('click', async () => {
            const res = await fetch('/api/config');
            const config = await res.json();
            renderHistoryList(config.context_history || [], currentWindowSize);
            showToast('å·²åˆ·æ–°');
        });

        // æ¸…ç©ºå†å²æŒ‰é’®
        document.getElementById('clear-history-btn').addEventListener('click', clearAllHistory);

        // ç¼–è¾‘æ¨¡æ€æ¡†äº‹ä»¶
        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            document.getElementById('edit-modal').classList.remove('show');
        });
        document.getElementById('save-edit-btn').addEventListener('click', saveEditedHistory);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal') {
                document.getElementById('edit-modal').classList.remove('show');
            }
        });

        // ========== å¿«æ·é”®è®¾ç½®ç›¸å…³ ==========
        let isRecordingShortcut = false;
        let recordedModifiers = new Set();  // å½“å‰æŒ‰ä¸‹çš„ä¿®é¥°é”®
        let recordedMainKey = null;         // ä¸»é”®

        // ä¿®é¥°é”®æ˜ å°„
        const MODIFIER_KEY_MAP = {
            'Control': 'ctrl',
            'Alt': 'alt',
            'Shift': 'shift',
            'Meta': 'cmd',
            'OS': 'cmd'
        };

        // ä¿®é¥°é”®æ˜¾ç¤ºåç§°
        const MODIFIER_DISPLAY = {
            'ctrl': 'Ctrl',
            'alt': 'Alt',
            'shift': 'Shift',
            'cmd': 'Cmd'
        };

        // åŠ è½½å¿«æ·é”®é…ç½®
        async function loadShortcuts() {
            try {
                const response = await fetch('/api/shortcuts');
                const data = await response.json();

                // æ›´æ–°å½“å‰å¿«æ·é”®æ˜¾ç¤º
                document.getElementById('current-shortcut').textContent = data.current.display;
            } catch (error) {
                console.error('åŠ è½½å¿«æ·é”®å¤±è´¥:', error);
            }
        }

        // ä¿å­˜å¿«æ·é”®
        async function saveShortcut(key, display) {
            try {
                await fetch('/api/shortcuts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, display })
                });
                document.getElementById('current-shortcut').textContent = display;
                showToast('å¿«æ·é”®å·²ä¿å­˜');
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥');
            }
        }

        // å¼€å§‹å½•åˆ¶å¿«æ·é”®
        function startRecordingShortcut() {
            if (isRecordingShortcut) return;
            isRecordingShortcut = true;
            recordedModifiers.clear();
            recordedMainKey = null;

            const btn = document.getElementById('record-shortcut-btn');
            btn.textContent = 'ç­‰å¾…æŒ‰é”®...';
            btn.classList.add('recording');

            // ç›‘å¬é”®ç›˜äº‹ä»¶
            document.addEventListener('keydown', handleShortcutKeydown);
            document.addEventListener('keyup', handleShortcutKeyup);
        }

        // åœæ­¢å½•åˆ¶å¿«æ·é”®
        function stopRecordingShortcut() {
            isRecordingShortcut = false;
            recordedModifiers.clear();
            recordedMainKey = null;

            const btn = document.getElementById('record-shortcut-btn');
            btn.textContent = 'ç‚¹å‡»å½•åˆ¶';
            btn.classList.remove('recording');

            document.removeEventListener('keydown', handleShortcutKeydown);
            document.removeEventListener('keyup', handleShortcutKeyup);
        }

        // è·å–å½“å‰å½•åˆ¶çŠ¶æ€çš„æ˜¾ç¤ºæ–‡æœ¬
        function getRecordingDisplayText() {
            const parts = [];

            // æŒ‰å›ºå®šé¡ºåºæ·»åŠ ä¿®é¥°é”®
            ['ctrl', 'alt', 'shift', 'cmd'].forEach(mod => {
                if (recordedModifiers.has(mod)) {
                    parts.push(MODIFIER_DISPLAY[mod]);
                }
            });

            if (recordedMainKey) {
                parts.push(recordedMainKey.display);
            } else if (parts.length > 0) {
                parts.push('...');
            }

            return parts.length > 0 ? parts.join(' + ') : 'ç­‰å¾…æŒ‰é”®...';
        }

        // å¤„ç†å¿«æ·é”®æŒ‰ä¸‹
        function handleShortcutKeydown(e) {
            e.preventDefault();
            e.stopPropagation();

            // Esc å–æ¶ˆå½•åˆ¶
            if (e.key === 'Escape') {
                stopRecordingShortcut();
                showToast('å·²å–æ¶ˆ');
                return;
            }

            const btn = document.getElementById('record-shortcut-btn');

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¿®é¥°é”®
            if (MODIFIER_KEY_MAP[e.key]) {
                const modKey = MODIFIER_KEY_MAP[e.key];
                recordedModifiers.add(modKey);
                btn.textContent = getRecordingDisplayText();
                return;
            }

            // éä¿®é¥°é”® - ä½œä¸ºä¸»é”®
            const mainKeyInfo = getMainKeyInfo(e);
            if (mainKeyInfo) {
                recordedMainKey = mainKeyInfo;
                btn.textContent = getRecordingDisplayText();
            }
        }

        // å¤„ç†å¿«æ·é”®é‡Šæ”¾
        function handleShortcutKeyup(e) {
            if (!isRecordingShortcut) return;

            e.preventDefault();
            e.stopPropagation();

            // æ£€æŸ¥æ˜¯å¦æ˜¯ä¿®é¥°é”®é‡Šæ”¾
            if (MODIFIER_KEY_MAP[e.key]) {
                const modKey = MODIFIER_KEY_MAP[e.key];

                // å¦‚æœåªæœ‰ä¿®é¥°é”®ï¼ˆå•é”®æ¨¡å¼ï¼‰ï¼Œåœ¨é‡Šæ”¾æ—¶ä¿å­˜
                if (recordedModifiers.has(modKey) && recordedModifiers.size === 1 && !recordedMainKey) {
                    // å•ä¸ªä¿®é¥°é”®ä½œä¸ºå¿«æ·é”®ï¼ˆå‘åå…¼å®¹ï¼‰
                    const singleKeyInfo = getSingleModifierKeyInfo(e);
                    if (singleKeyInfo) {
                        stopRecordingShortcut();
                        saveShortcut(singleKeyInfo.key, singleKeyInfo.display);
                        return;
                    }
                }

                recordedModifiers.delete(modKey);
                const btn = document.getElementById('record-shortcut-btn');
                btn.textContent = getRecordingDisplayText();
                return;
            }

            // éä¿®é¥°é”®é‡Šæ”¾ - å®Œæˆå½•åˆ¶
            if (recordedMainKey) {
                const shortcutInfo = buildShortcutInfo();
                stopRecordingShortcut();
                if (shortcutInfo) {
                    saveShortcut(shortcutInfo.key, shortcutInfo.display);
                }
            }
        }

        // è·å–ä¸»é”®ä¿¡æ¯
        function getMainKeyInfo(e) {
            const key = e.key;
            const code = e.code;

            // åŠŸèƒ½é”®
            if (code.startsWith('F') && code.length <= 3) {
                const fNum = code.substring(1);
                if (fNum >= 1 && fNum <= 12) {
                    return { key: `f${fNum}`, display: `F${fNum}` };
                }
            }

            // ç‰¹æ®Šé”®
            if (key === ' ' || code === 'Space') return { key: 'space', display: 'Space' };
            if (key === 'Tab') return { key: 'tab', display: 'Tab' };
            if (key === 'CapsLock') return { key: 'caps_lock', display: 'CapsLock' };

            // æ™®é€šå­—ç¬¦é”®ï¼ˆa-z, 0-9 ç­‰ï¼‰
            if (key.length === 1 && /[a-zA-Z0-9]/.test(key)) {
                return { key: key.toLowerCase(), display: key.toUpperCase() };
            }

            return null;
        }

        // è·å–å•ä¸ªä¿®é¥°é”®çš„ä¿¡æ¯ï¼ˆå‘åå…¼å®¹ï¼‰
        function getSingleModifierKeyInfo(e) {
            const key = e.key;
            const location = e.location;

            if (key === 'Meta' || key === 'OS') {
                if (location === 2) return { key: 'cmd_r', display: 'Right Command' };
                return { key: 'cmd_l', display: 'Left Command' };
            }
            if (key === 'Control') {
                if (location === 2) return { key: 'ctrl_r', display: 'Right Control' };
                return { key: 'ctrl_l', display: 'Left Control' };
            }
            if (key === 'Alt') {
                if (location === 2) return { key: 'alt_r', display: 'Right Alt/Option' };
                return { key: 'alt_l', display: 'Left Alt/Option' };
            }
            if (key === 'Shift') {
                if (location === 2) return { key: 'shift_r', display: 'Right Shift' };
                return { key: 'shift_l', display: 'Left Shift' };
            }

            return null;
        }

        // æ„å»ºå¿«æ·é”®ä¿¡æ¯
        function buildShortcutInfo() {
            if (!recordedMainKey && recordedModifiers.size === 0) {
                return null;
            }

            const keyParts = [];
            const displayParts = [];

            // æŒ‰å›ºå®šé¡ºåºæ·»åŠ ä¿®é¥°é”®
            ['ctrl', 'alt', 'shift', 'cmd'].forEach(mod => {
                if (recordedModifiers.has(mod)) {
                    keyParts.push(mod);
                    displayParts.push(MODIFIER_DISPLAY[mod]);
                }
            });

            if (recordedMainKey) {
                keyParts.push(recordedMainKey.key);
                displayParts.push(recordedMainKey.display);
            }

            return {
                key: keyParts.join('+'),
                display: displayParts.join(' + ')
            };
        }

        // ç»‘å®šå¿«æ·é”®å½•åˆ¶æŒ‰é’®äº‹ä»¶
        document.getElementById('record-shortcut-btn').addEventListener('click', startRecordingShortcut);

        // é¡µé¢åŠ è½½æ—¶è·å–é…ç½®
        loadConfig();
        loadShortcuts();
    </script>
</body>
</html>
